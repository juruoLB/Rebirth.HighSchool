<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REBIRTH_HIGHSCHOOL_V5.5.1</title>
    <style>
        /* ==================== GLOBAL THEME ==================== */
        /* [V5.5.1 FIX] å¼ºåˆ¶ä¿ç•™æ»šåŠ¨æ¡è½¨é“ï¼Œé˜²æ­¢é¡µé¢å®½åº¦è·³åŠ¨ */
        html {
            overflow-y: scroll; 
        }
        :root {
            --bg: #000000;
            --fg: #e0e0e0;
            --highlight: #ffffff;
            --accent: #ffffff;
            --border: 2px solid #ffffff;
            --dim: #666666;
            --font: 'Consolas', 'Courier New', monospace;
        }

        body {
            background-color: var(--bg); color: var(--fg); font-family: var(--font);
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* é€šç”¨ï¼šæ•…éšœæ–‡å­—ç‰¹æ•ˆ */
        .glitch {
            position: relative; animation: glitch 1s infinite alternate;
            text-shadow: 2px 2px 0px #333; font-weight: bold; letter-spacing: 2px;
        }
        @keyframes glitch {
            0% { text-shadow: 2px 2px 0px #333; }
            100% { text-shadow: -2px -2px 0px #333; }
        }

        /* é€šç”¨ï¼šéšè—ç±» */
        .hidden { display: none !important; }
        
        /* é€šç”¨ï¼šç¡¬æ ¸æŒ‰é’® */
        .btn {
            background: black; color: white; border: 2px solid white;
            padding: 10px 20px; font-family: inherit; font-weight: bold; cursor: pointer;
            text-transform: uppercase; transition: all 0.1s; margin: 5px;
        }
        .btn:hover:not(:disabled) { background: white; color: black; }
        .btn:disabled { border-color: #444; color: #444; cursor: not-allowed; }

        /* ==================== SCREEN 1: SETUP (å¤åˆ»æ‚¨çš„æœ€çˆ±) ==================== */
        #screen-setup {
            width: 100%; max-width: 700px; height: 90vh;
            border: var(--border); padding: 30px; box-sizing: border-box;
            background: #050505; overflow-y: auto;
            display: flex; flex-direction: column; gap: 20px;
            box-shadow: 0 0 20px rgba(255,255,255,0.1);
        }

        .form-group label { display: block; margin-bottom: 8px; color: var(--highlight); }
        input[type="text"] {
            background: transparent; border: none; border-bottom: 2px solid white;
            color: white; font-family: inherit; font-size: 1.2rem; width: 100%; outline: none;
        }
        
        /* é€‰ç§‘ Grid */
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .option-box {
            border: 1px solid #444; padding: 15px; text-align: center; cursor: pointer; user-select: none;
        }
        .option-box.selected, .option-box.active {
            background: white; color: black; border-color: white; font-weight: bold;
        }

        /* å±æ€§åŠ ç‚¹å™¨ */
        .stat-allocator { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #333; padding: 5px 0; }

        /* ==================== SCREEN 2: GAMEPLAY (ä»ªè¡¨ç›˜) ==================== */
        #screen-game {
            width: 100%; height: 100%; display: flex; gap: 10px; padding: 10px; box-sizing: border-box;
        }
        
        .panel { 
            border: 1px solid #333; background: #0a0a0a; padding: 10px; 
            display: flex; flex-direction: column;
        }
        
        /* å·¦ä¾§çŠ¶æ€ (30%) */
        #col-stats { flex: 3; }
        /* ä¸­é—´æ—¥å¿— (40%) */
        #col-main { flex: 4; border-color: #666; } /* ä¸»å±è¾¹æ¡†äº®ä¸€ç‚¹ */
        /* å³ä¾§æ“ä½œ (30%) */
        #col-action { flex: 3; }

        .stat-bar { margin-bottom: 12px; }
        .progress-track { background: #222; height: 10px; border: 1px solid #444; margin-top: 4px; }
        .progress-fill { height: 100%; background: #fff; width: 50%; transition: width 0.3s; }
        
        /*#game-log { 
            flex: 1; overflow-y: auto; font-size: 0.9rem; line-height: 1.4; 
            border-top: 1px dashed #333; margin-top: 10px; padding-top: 10px;
        }*/
        #game-log { 
            flex: 1; 
            overflow-y: auto; 
            font-size: 0.9rem; 
            line-height: 1.4; 
            border-top: 1px dashed #333; 
            margin-top: 10px; 
            padding-top: 10px;
            /* ä¿æŒä½ é‚£ä¸ªé…·ç‚«çš„æ¸å˜æ¶ˆå¤±æ•ˆæœ */
            -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
            /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™æ»šåŠ¨åŠŸèƒ½ï¼ˆå¯é€‰ï¼Œå¢åŠ ç¾æ„Ÿï¼‰ */
            scrollbar-width: none; 
        }
        #game-log::-webkit-scrollbar { display: none; }

        /* [NEW] æ‰“å­—æœºå…‰æ ‡é—ªçƒ */
        .cursor::after {
            content: '|';
            display: inline-block;
            margin-left: 2px;
            animation: blink 1s step-end infinite;
            color: #2ecc71; /* å…‰æ ‡è®¾ä¸ºç»¿è‰²ï¼Œåƒè€å¼ç»ˆç«¯ */
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        /* æ ‡è¯­å®¹å™¨æ ·å¼ */
        #slogan-box {
            margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
            padding-top: 20px;
            border-top: 1px solid #333;
            font-family: 'SimSun', 'Songti SC', serif; /* å®‹ä½“æ›´æœ‰å­¦æ ¡æ ‡è¯­çš„æ„Ÿè§‰ */
            font-size: 0.9rem;
            color: #aaa;
            min-height: 60px; /* é¢„ç•™é«˜åº¦é˜²æ­¢è·³åŠ¨ */
            line-height: 1.5;
            font-style: italic;
        }
        .log-entry { margin-bottom: 5px; }
        .log-turn { color: #888; margin-right: 5px; }
    </style>
</head>
<body>
    <!-- [NEW] åŠ¨æ€ç²’å­èƒŒæ™¯ç”»å¸ƒ -->
    <canvas id="particle-canvas" style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1; pointer-events:none;"></canvas>

    <!-- åŸæœ‰çš„æ¸¸æˆå®¹å™¨ -->
    <div id="game-container">
        ...
    <!-- SCREEN 1: å¯åŠ¨åè®® -->
    <div id="screen-setup">
        <h1 class="glitch">> REBIRTH_PROTOCOL.EXE</h1>
        <!-- åœ¨ <h1 class="glitch">...</h1> ä¹‹åæ’å…¥ä»¥ä¸‹ä»£ç  -->

        <div style="font-size: 0.7rem; color: #666; margin: -15px 0 20px 0; border-left: 3px solid #666; padding-left: 10px; line-height: 1.4;">
        <strong>[å…è´£å£°æ˜]</strong> æœ¬ç¨‹åºä¸ºè™šæ„çš„æ•™å­¦ä¸å¨±ä¹æ¨¡æ‹Ÿç³»ç»Ÿã€‚
        <br>æ‰€æœ‰è®­ç»ƒå‚æ•°ã€æˆç»©ç®—æ³•ã€èµ„æºåˆ†é…æ¨¡å‹å‡ä¸ºç©æ³•è®¾å®šã€‚
        <br>æ¶‰åŠçš„äººåã€åœ°åã€äº‹ä»¶å‡ä¸ºéšæœºç”Ÿæˆæˆ–è‰ºæœ¯åŠ å·¥ï¼Œä¸ç°å®ä¸–ç•Œæ— ä»»ä½•å…³è”ã€‚
        </div>
        
        <div class="form-group">
            <label>> å®¿ä¸»ä»£å· (ID):</label>
            <input type="text" id="inp-name" value="Player1" maxlength="8">
        </div>

        <div class="form-group">
            <label>> ä¸–ç•Œçº¿éš¾åº¦:</label>
            <div class="grid-3" id="diff-select">
                <!-- JS ç”Ÿæˆ -->
            </div>
            <p id="diff-desc" style="font-size: 0.8rem; color: #888; margin-top:5px;"></p>
        </div>

        <div class="form-group">
            <label>> é«˜è€ƒé€‰ç§‘ (3+3 / å·²é€‰: <span id="sub-count">0</span>/3):</label>
            <div class="grid-3" id="sub-select">
                <!-- JS ç”Ÿæˆ -->
            </div>
        </div>

        <div class="form-group">
            <label>> åˆå§‹å¤©èµ‹åˆ†é… (å‰©ä½™ç‚¹æ•°: <span id="remain-pts">0</span>):</label>
            <div id="stat-select">
                <!-- JS ç”Ÿæˆ -->
            </div>
        </div>

        <div style="margin-top: auto;">
            <button id="btn-start" class="btn" style="width:100%" disabled>ç³»ç»Ÿæ ¡å‡†ä¸­...</button>
            <div style="text-align: center; margin-top: 10px; font-size: 0.8rem; color: #666;">
                <span id="load-status">ARCHIVE_NOT_FOUND</span>
            </div>
        </div>
    </div>

    <!-- SCREEN 2: å‘½è¿ä¸»å®° -->
    <div id="screen-game" class="hidden">
        <!-- å·¦ä¾§ï¼šçŠ¶æ€ç›‘æ§ -->
        <div id="col-stats" class="panel">
            <h3 style="border-bottom: 2px solid white; padding-bottom:5px; margin-top:0;">STATUS</h3>
            <div id="ui-stats-container">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ä¸­é—´ï¼šæ ¸å¿ƒæ˜¾ç¤º -->
        <div id="col-main" class="panel">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin:0;">SYSTEM_LOG</h3>
                <span id="ui-turn" style="background: white; color: black; padding: 2px 6px; font-weight: bold;">TURN 1/48</span>
            </div>
            <div style="border-bottom: 1px solid #333; margin: 10px 0; padding-bottom: 5px; text-align: center;">
                <span id="ui-school">LOADING...</span> | è·ç¦»é«˜è€ƒ <span id="ui-countdown">48</span> å‘¨
            </div>
            <div id="game-log">
                <!-- æ—¥å¿—æµ -->
            </div>
        </div>

        <!-- å³ä¾§ï¼šæ§åˆ¶å° -->
        <div id="col-action" class="panel">
            <h3 style="border-bottom: 2px solid white; padding-bottom:5px; margin-top:0;">COMMANDS</h3>
            <button class="btn" onclick="Game.saveGame()">ğŸ’¾ æ‰‹åŠ¨å­˜æ¡£</button>
            <hr style="border: 0; border-top: 1px dashed #333; margin: 15px 0;">
            <div id="ui-actions">
                <!-- åŠ¨æ€ç”Ÿæˆæ“ä½œæŒ‰é’® -->
            </div>
        </div>
    </div>

    <!-- é€»è¾‘è„šæœ¬ -->
    <script>
/* =================================================================
       REBIRTH HIGHSCHOOL V5.5.2 (UNCOMPRESSED FINAL)
       ================================================================= */
    
        /* =================================================================
   CLOUDSYNC MODULE (NEW v6.0)
   ================================================================= */
    const CloudSync = {
        // æ‹¦æˆªåˆ†äº«é“¾æ¥
        checkShareMode: async function() {
            const params = new URLSearchParams(window.location.search);
            const sid = params.get('shareId');
            if (sid) {
                try {
                    const res = await fetch(`/api/share/${sid}`);
                    if (res.ok) {
                        const data = await res.json();
                        this.renderShareCard(data);
                        return true; // æ‹¦æˆªæˆåŠŸ
                    }
                } catch (e) { console.error("Cloud Error"); }
            }
            return false;
        },

        // æ¸²æŸ“æˆ˜æŠ¥è¦†ç›–å±‚
        renderShareCard: function(data) {
            document.body.innerHTML = `
                <div style="background:#000; color:#fff; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; font-family:monospace; text-align:center; border:5px double #ffd700;">
                    <h1 class="glitch" style="color:#ffd700;">ğŸ† é‡ç”Ÿè€…è£èª‰æˆ˜æŠ¥</h1>
                    <div style="font-size:1.2rem; margin:20px; line-height:2; border-top:1px dashed #444; border-bottom:1px dashed #444; padding:20px;">
                        <p>å®¿ä¸»ä»£å·ï¼š<span style="color:#2ecc71">${data.name}</span></p>
                        <p>${data.ending.includes('å´©æºƒ') ? 'ç»¼åˆè¯„ä»·' : 'é«˜è€ƒæ€»åˆ†'}ï¼š<span style="font-size:1.5rem; color:#f1c40f">${data.ending.includes('å´©æºƒ') ? '???' : data.score}</span></p>
<p>${data.ending.includes('å´©æºƒ') ? 'æœ€ç»ˆå»å‘' : 'å½•å–é™¢æ ¡'}ï¼š<span style="font-size:1.5rem; color:#3498db">${data.uni}</span></p>
                        <p>ç»“å±€ï¼š${data.ending}</p>
                    </div>
                    <button class="btn" onclick="window.location.href='/'">æˆ‘ä¹Ÿè¦é‡ç”Ÿ</button>
                </div>
            `;
        }
    };   

    /* -----------------------------------------------------------------
       MODULE 1: GAME CONFIG (é…ç½®æ•°æ®åº“)
       ----------------------------------------------------------------- */
    const GameConfig = {
        MAX_TURNS: 48,
        TIME_PER_TURN: 300,
        
        Difficulty: {
            easy: { 
                name: "çˆ½æ–‡ (Easy)", 
                points: 25, 
                money: 3000, 
                desc: "èµ„æºå……æ²›ï¼Œé€‚åˆä½“éªŒå‰§æƒ…ã€‚" 
            },
            normal: { 
                name: "ç°å® (Normal)", 
                points: 20, 
                money: 800, 
                desc: "æ ‡å‡†éš¾åº¦ï¼Œä¸ä»…è¦åŠªåŠ›ï¼Œè¿˜è¦çœ‹è¿æ°”ã€‚" 
            },
            hard: { 
                name: "åœ°ç‹± (Hard)", 
                points: 15, 
                money: 0, 
                desc: "å¤©å´©å¼€å±€ï¼Œè´Ÿé‡å‰è¡Œã€‚" 
            }
        },

        Schools: {
            ordinary: {
                relaxed: { name: "å¿åŸå››ä¸­", buff: "æ”¾ç¾Š", eff: 0.8, stress: 0, minScore: 400 },
                balanced: { name: "å¿åŸäºŒä¸­", buff: "å¹³åº¸", eff: 0.9, stress: 5, minScore: 450 },
                strict: { name: "æ¯›å¦å‚åˆ†æ ¡", buff: "é¢˜æµ·", eff: 1.1, stress: 15, minScore: 480 }
            },
            key: {
                relaxed: { name: "å¸‚å®éªŒ(ç´ è´¨ç­)", buff: "å…¨èƒ½", eff: 1.0, stress: 5, minScore: 500 },
                balanced: { name: "å¸‚ä¸€ä¸­", buff: "åå¸ˆ", eff: 1.1, stress: 10, minScore: 550 },
                strict: { name: "å®å¿—ç­", buff: "é«˜å‹", eff: 1.3, stress: 20, minScore: 580 }
            },
            super: {
                relaxed: { name: "å¤æ—¦é™„ä¸­", buff: "ç¥ä»™", eff: 1.2, stress: 8, minScore: 600 },
                balanced: { name: "å­¦å†›ä¸­å­¦", buff: "ç«èµ›", eff: 1.4, stress: 15, minScore: 630 },
                strict: { name: "è¡¡æ°´æ€»æ ¡", buff: "æœºå™¨", eff: 1.6, stress: 30, minScore: 660 }
            }
        },

        Stats: {
            iq: { name: "æ™ºåŠ›", base: 5 },
            logic: { name: "é€»è¾‘", base: 1 },
            img: { name: "æƒ³è±¡", base: 1 },
            mem: { name: "è®°å¿†", base: 1 },
            sta: { name: "ä½“é­„", base: 5 },
            fam: { name: "å®¶å¢ƒ", base: 5 }
        },

        Subjects: {
            chn: { name: "è¯­æ–‡", type: "core", boost: "img", costT: 40, costS: 20 },
            math: { name: "æ•°å­¦", type: "core", boost: "logic", costT: 45, costS: 25 },
            eng: { name: "è‹±è¯­", type: "core", boost: "mem", costT: 40, costS: 20 },
            phy: { name: "ç‰©ç†", type: "sci", boost: "logic", costT: 35, costS: 25 },
            chem: { name: "åŒ–å­¦", type: "sci", boost: "mem", costT: 35, costS: 22 },
            bio: { name: "ç”Ÿç‰©", type: "sci", boost: "mem", costT: 35, costS: 20 },
            his: { name: "å†å²", type: "arts", boost: "mem", costT: 40, costS: 18 },
            pol: { name: "æ”¿æ²»", type: "arts", boost: "img", costT: 40, costS: 18 },
            geo: { name: "åœ°ç†", type: "arts", boost: "logic", costT: 35, costS: 20 }
        },

        Calendar: {
            holidays: [8, 15, 16, 24, 31, 32, 40],
            exams: [3, 7, 11, 14, 19, 23, 27, 30, 35, 39, 42, 45, 47, 48],
            getDesc: function(turn) {
                if (turn === 8) return "ã€é«˜ä¸€å¯’å‡ã€‘";
                if (turn === 15 || turn === 16) return "ã€é«˜ä¸€æš‘å‡ã€‘";
                if (turn === 24) return "ã€é«˜äºŒå¯’å‡ã€‘";
                if (turn === 31 || turn === 32) return "ã€é«˜äºŒæš‘å‡ã€‘";
                if (turn === 40) return "ã€é«˜ä¸‰å¯’å‡ã€‘";
                if (turn === 42) return "ã€ä¸€æ¨¡ã€‘";
                if (turn === 45) return "ã€äºŒæ¨¡ã€‘";
                if (turn === 47) return "ã€ä¸‰æ¨¡ã€‘";
                if (turn === 48) return "ã€é«˜è€ƒã€‘";
                return "";
            }
        },

        CompetitionSchedule: {
            3: { stage: 1, name: "S1åˆèµ›(é«˜ä¸€)", req: 40 },
            7: { stage: 2, name: "S2å¤èµ›(é«˜ä¸€)", req: 120 },
            12: { stage: 3, name: "NOIPçœé€‰(é«˜ä¸€)", req: 250 },
            16: { stage: 4, name: "NOIå›½èµ›(é«˜ä¸€)", req: 500 },
            19: { stage: 1, name: "S1åˆèµ›(é«˜äºŒ)", req: 80 },
            23: { stage: 2, name: "S2å¤èµ›(é«˜äºŒ)", req: 200 },
            28: { stage: 3, name: "NOIPçœé€‰(é«˜äºŒ)", req: 400 },
            32: { stage: 4, name: "NOIå›½èµ›(é«˜äºŒ)", req: 700 },
            35: { stage: 1, name: "S1åˆèµ›(é«˜ä¸‰)", req: 150 },
            39: { stage: 2, name: "S2å¤èµ›(é«˜ä¸‰)", req: 300 }
        },

        NPCs: [
            { 
                id: "xiao", name: "è§ç«ç«", gender: "M", desc: "è«æ¬ºå°‘å¹´ç©·", 
                condition: (p) => p.stats.stress > 60, 
                cost: { t: 50, s: 15, m: 0 }, 
                effect: (p) => { 
                    p.stats.stress -= 20; 
                    p.stats.satisfaction += 2; 
                    return "å¬è§ç«ç«åæ§½äº†ä¸€å°æ—¶ï¼Œå¿ƒæƒ…èˆ’ç•…ã€‚"; 
                } 
            },
            { 
                id: "anon", name: "åƒæ—©çˆ±éŸ³", gender: "F", desc: "çˆ±æ…•è™šè£çš„JK", 
                condition: (p) => p.stats.money > 200, 
                cost: { t: 100, s: 10, m: 200 }, 
                effect: (p) => { 
                    p.stats.charm += 2; 
                    p.stats.stress -= 40; 
                    return "é™ªçˆ±éŸ³é€›éäº†å•†åœºï¼Œæ—¶é—´é£é€ã€‚"; 
                } 
            },
            { 
                id: "night", name: "ç¥å¤œæœˆ", gender: "M", desc: "è‹¹æœå¤©æ‰", 
                condition: (p) => p.stats.iq > 8, 
                cost: { t: 30, s: 30, m: 0 }, 
                effect: (p) => { 
                    p.stats.logic += 2; 
                    p.stats.stress += 5; 
                    return "ç¥å¤œæœˆæŒ‡å‡ºäº†ä½ å…¬å¼çš„é”™è¯¯ã€‚"; 
                } 
            },
            { 
                id: "misaka", name: "å¾¡å‚ç¾ç´", gender: "F", desc: "è¶…ç”µç£ç‚®", 
                condition: (p) => p.subjects.includes('phy') && p.stats.logic > 15, 
                cost: { t: 60, s: 35, m: 0 }, 
                effect: (p) => { 
                    p.stats.logic += 3; 
                    p.stats.satisfaction += 5; 
                    return "æ”¾å­¦åä¸€èµ·åšå®éªŒã€‚"; 
                } 
            }
        ],

        UniversityList: {
            tier9: { name: "æ¸…åŒ— (TOP2)", list: ["æ¸…åå¤§å­¦", "åŒ—äº¬å¤§å­¦"] },
            tier8: { name: "åäº”äºº (TOP3-8)", list: ["å¤æ—¦å¤§å­¦", "ä¸Šæµ·äº¤é€šå¤§å­¦", "æµ™æ±Ÿå¤§å­¦", "å—äº¬å¤§å­¦", "ä¸­å›½ç§‘å­¦æŠ€æœ¯å¤§å­¦", "ä¸­å›½äººæ°‘å¤§å­¦"] },
            tier7: { name: "ä¸­åšä¹æ ¡", list: ["åŒæµå¤§å­¦", "åä¸­ç§‘æŠ€å¤§å­¦", "æ­¦æ±‰å¤§å­¦", "å“ˆå°”æ»¨å·¥ä¸šå¤§å­¦", "è¥¿å®‰äº¤é€šå¤§å­¦", "åŒ—äº¬èˆªç©ºèˆªå¤©å¤§å­¦"] },
            tier6: { name: "å¼ºåŠ¿211/985", list: ["è¥¿å®‰ç”µå­ç§‘æŠ€å¤§å­¦", "ä¸œåŒ—å¤§å­¦", "å‰æ—å¤§å­¦", "å››å·å¤§å­¦", "åå—ç†å·¥å¤§å­¦"] },
            tier5: { name: "æ™®é€š211", list: ["å®‰å¾½å¤§å­¦", "è‹å·å¤§å­¦", "ä¸Šæµ·å¤§å­¦", "å—æ˜Œå¤§å­¦", "éƒ‘å·å¤§å­¦"] },
            tier4: { name: "ä¸€æœ¬é™¢æ ¡", list: ["æ±Ÿè‹å¤§å­¦", "æ·±åœ³å¤§å­¦", "æµ™æ±Ÿå·¥ä¸šå¤§å­¦", "å—äº¬é‚®ç”µå¤§å­¦"] },
            tier3: { name: "äºŒæœ¬é™¢æ ¡", list: ["xxç†å·¥å­¦é™¢", "xxç§‘æŠ€å­¦é™¢", "xxå¸ˆèŒƒå­¦é™¢"] },
            tier2: { name: "æ°‘åŠ/å¤§ä¸“", list: ["å®¶é‡Œè¹²èŒä¸šæŠ€æœ¯å­¦é™¢", "xxèŒä¸šå­¦é™¢", "æ°‘åŠä¸‰æœ¬"] },
            tier1: { name: "è½æ¦œ", list: ["ç¤¾ä¼šå¤§å­¦ (æ‰“å·¥)", "å¤è¯»ç­"] }
        },

        Endings: {
            BE1: { title: "å¿ƒç†å´©æºƒ", desc: "è¿˜æ²¡æ’‘åˆ°é«˜è€ƒï¼Œä½ çš„ç²¾ç¥å°±å·²ç»æ–­äº†å¼¦ã€‚ä¼‘å­¦æ²»ç–—æˆ–è®¸æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚", color: "#7f8c8d" },
            BE2: { title: "è¿·æƒ˜ç»“å±€", desc: "é«˜è€ƒåè½å­™å±±ï¼Œçœ‹ç€ç©ºè¡è¡çš„å½•å–æŸ¥è¯¢é¡µé¢ï¼Œä½ ä¸çŸ¥é“æœªæ¥åœ¨ä½•æ–¹ã€‚", color: "#95a5a6" },
            NE: { title: "å¹³æ·¡ç»“å±€", desc: "è€ƒä¸Šäº†ä¸€æ‰€æ™®é€šçš„å¤§å­¦ï¼Œè¿‡ç€æ™®é€šçš„ç”Ÿæ´»ã€‚è¿™æˆ–è®¸å°±æ˜¯å¤§å¤šæ•°äººçš„å½’å®¿ã€‚", color: "#bdc3c7" },
            GE1: { title: "æˆ˜æ–—ç»“å±€", desc: "ä½ åœ¨é«˜å‹ä¸‹æµ´ç«é‡ç”Ÿï¼è™½ç„¶è¿‡ç¨‹ç—›è‹¦ï¼Œä½†ä½ èµ¢å¾—äº†å¼ºæ ¡çš„å…¥åœºåˆ¸ï¼", color: "#e67e22" },
            GE2: { title: "é€†è¢­ç»“å±€", desc: "æ›¾è¢«è€å¸ˆå’Œå®¶é•¿æ”¾å¼ƒçš„ä½ ï¼Œåœ¨æœ€åä¸€åˆ»åˆ›é€ äº†å¥‡è¿¹ï¼", color: "#f39c12" },
            SE1: { title: "ç«èµ›å›½ç‰Œä½¬", desc: "è™½ç„¶æ²¡è¿›å›½å®¶é˜Ÿï¼Œä½†å›½èµ›ç»å†å°†æ˜¯ä½ ä¸€ç”Ÿçš„è´¢å¯Œã€‚", color: "#9b59b6" },
            SE2: { title: "ç«èµ›é‡‘ç‰Œå¤§ç¥", desc: "é‡‘ç‰Œåœ¨æ‰‹ï¼Œæ¸…åŒ—æˆ‘æœ‰ï¼ä½ æ˜¯ç«™åœ¨æ™ºåŠ›å·…å³°çš„ä¼ è¯´ï¼", color: "#ffd700" },
            EX1: { title: "è¿™è¿˜æ˜¯äººç±»å—", desc: "ä½ æ˜¯å¦‚ä½•åšåˆ°åœ¨æ¯«æ— å‹åŠ›çš„æƒ…å†µä¸‹è€ƒä¸ŠTop2çš„ï¼Ÿå¤–æ˜Ÿäººè¯·å›ç«æ˜Ÿï¼", color: "#00b894" },
            PE: { title: "ç¢¾å‹çš„å¼€å§‹ (å®Œç¾)", desc: "å·¦æ‰‹æ¸…åŒ—é€šçŸ¥ä¹¦ï¼Œå³æ‰‹æŒšå‹ç›¸ä¼´ã€‚ä½ æ˜¯å½“ä¹‹æ— æ„§çš„äººç”Ÿèµ¢å®¶ï¼", color: "#e84393" },
            IE: { title: "ç»å¯¹åæ€", desc: "ä»¥å‡¡äººä¹‹èº¯ï¼Œæ¯”è‚©ç¥æ˜ï¼ç”¨æä½çš„é¢æ¿å±æ€§é€šè¿‡äº†æœ€é«˜éš¾åº¦çš„å‰¯æœ¬ï¼", color: "#ff7675" },
            JSE: { title: "å°ä½¬ä¸€ä½", desc: "æ³¢æ¾œä¸æƒŠï¼Œç¨³ç¨³å½“å½“è€ƒå…¥åæ ¡ã€‚ç¨³ï¼Œå°±æ˜¯æœ€å¤§çš„å¼ºã€‚", color: "#0984e3" },
            DEF: { title: "çœŸå®é«˜ä¸­ç”Ÿæ´»", desc: "æ²¡æœ‰æƒŠå¿ƒåŠ¨é­„ï¼Œåªæœ‰æ—¥å¤ä¸€æ—¥çš„åšæŒã€‚è¿™æ‰æ˜¯çœŸå®çš„é’æ˜¥ã€‚", color: "#b2bec3" }
        },

        Achievements: {
            "TOP_SCH": { title: "åæ ¡ç”Ÿï¼", cond: "è€ƒå…¥Top985/æ¸…åŒ—çº§åˆ«çš„å­¦æ ¡", desc: "å¦‚æœä¸­å›½é«˜ä¸­åº”è¯•æ•™è‚²æ˜¯ä¸€æ¬¾æ¸¸æˆï¼Œé‚£ä½ æ— ç–‘æ˜¯æ¸¸æˆçš„èµ¢å®¶ã€‚" },
            "ANON_100": { title: "çˆ±éŸ³åŒå­¦ï¼", cond: "åƒæ—©çˆ±éŸ³(Anon)å¥½æ„Ÿåº¦è¾¾åˆ°100", desc: "è°ä¸å–œæ¬¢æœ‰ä¸€åªç²‰è‰²çš„å°å¯çˆ±æ•´å¤©é™ªç€è‡ªå·±å‘¢ï¼Ÿ" },
            "FEN_JUE": { title: "åªå±äºæˆ‘çš„ç„šè¯€ï¼", cond: "è§ç«ç«å¥½æ„Ÿåº¦80+ä¸”è·å¾—ç§˜ç±", desc: "ä¸‰åå¹´æ²³ä¸œï¼Œä¸‰åå¹´æ²³è¥¿ï¼Œè«æ¬ºå°‘å¹´ç©·ï¼" },
            "KING": { title: "ç‹è€…ï¼", cond: "ç«èµ›æˆåŠŸè¿›å…¥å›½èµ›", desc: "å±¹ç«‹äºè¿™ä¸ªæ—¶ä»£çš„ç²¾è‹±è¡Œåˆ—ä¹‹ä¸­ï¼Œä½ å·²æ˜¯æœ€å¼ºè€…ä¹‹ä¸€ã€‚" },
            "PEAK": { title: "é¡¶ç‚¹ï¼", cond: "ç«èµ›åœ¨å›½èµ›ä¸­è·å¾—é‡‘ç‰Œ", desc: "æ— ä»–ï¼Œç»é¡¶æˆ‘ä¸ºå³°ã€‚" }
        }
    };

    /* -----------------------------------------------------------------
       MODULE 2: STATE MANAGER & ACHIEVEMENT MANAGER
       ----------------------------------------------------------------- */
    const StateManager = {
        data: {
            player: {
                name: "Unknown", 
                diff: "normal", 
                schoolKey: { tier: 'key', style: 'balanced' }, 
                subjects: [],
                stats: { 
                    iq: 0, logic: 0, img: 0, mem: 0, 
                    stamina: 100, maxStamina: 100, time: 300, 
                    stress: 0, satisfaction: 60, money: 0, charm: 0 
                },
                compStatus: { 
                    joined: false, 
                    currentStage: 0, 
                    bestRecord: "æ— ", 
                    hasGold: false, 
                    hasNational: false 
                },
                affinity: { xiao: 0, anon: 0, night: 0, misaka: 0 },
                hasSecretManual: false
            },
            game: { turn: 1, isGameOver: false, gameOverReason: "" },
            history: { maxStress: 0, failedExams: 0, crisisCount: 0, npcBondCount: 0 }
        },

        save: function() { 
            try { 
                localStorage.setItem('Rebirth_Save_V5', window.btoa(encodeURIComponent(JSON.stringify(this.data)))); 
                return true; 
            } catch (e) { 
                return false; 
            } 
        },

        load: function() { 
            const enc = localStorage.getItem('Rebirth_Save_V5'); 
            if (!enc) return false; 
            try { 
                this.data = JSON.parse(decodeURIComponent(window.atob(enc))); 
                return true; 
            } catch (e) { 
                return false; 
            } 
        },

        hasSave: function() { 
            return !!localStorage.getItem('Rebirth_Save_V5'); 
        }
    };

    const AchievementManager = {
        unlocked: [],
        
        init: function() { 
            const s = localStorage.getItem('Rebirth_Achievements'); 
            if (s) {
                try { this.unlocked = JSON.parse(s); } catch (e) { this.unlocked = []; } 
            }
        },

        unlock: function(id) {
            if (this.unlocked.includes(id) || !GameConfig.Achievements[id]) return;
            
            this.unlocked.push(id); 
            localStorage.setItem('Rebirth_Achievements', JSON.stringify(this.unlocked));
            
            // å¼¹çª—ç‰¹æ•ˆ
            const ach = GameConfig.Achievements[id];
            const div = document.createElement('div');
            div.style.cssText = "position:fixed; top:-100px; left:50%; transform:translateX(-50%); background:rgba(10,10,10,0.95); border:2px solid #ffd700; color:#ffd700; padding:15px 30px; border-radius:8px; z-index:10000; text-align:center; box-shadow:0 0 25px rgba(255, 215, 0, 0.2); transition: top 0.5s ease-out, opacity 0.5s;";
            div.innerHTML = `
                <div style='font-size:1.2rem; font-weight:bold; margin-bottom:5px'>ğŸ† æˆå°±è§£é”</div>
                <div style='color:white; font-size:1.1rem; font-weight:bold'>${ach.title}</div>
                <div style='font-size:0.8rem; color:#aaa; margin-top:5px; font-style:italic'>${ach.desc}</div>
            `;
            document.body.appendChild(div);
            
            requestAnimationFrame(() => { div.style.top = "30px"; });
            setTimeout(() => { 
                div.style.top = "-150px"; 
                div.style.opacity = "0"; 
                setTimeout(() => div.remove(), 500); 
            }, 4000);
            
            UI.log(`ğŸ† [æˆå°±] ${ach.title} å·²è¾¾æˆï¼`, "#ffd700");
        },

        isUnlocked: function(id) { return this.unlocked.includes(id); }
    };

    /* -----------------------------------------------------------------
       MODULE 3: ENGINE (é€»è¾‘æ ¸å¿ƒ)
       ----------------------------------------------------------------- */
    const Engine = {
        getSchoolConfig: function() { 
            const k = StateManager.data.player.schoolKey; 
            return GameConfig.Schools[k.tier][k.style]; 
        },

        calculateEfficiency: function() {
            const p = StateManager.data.player;
            let eff = Engine.getSchoolConfig().eff * (1 + p.stats.iq * 0.05);
            if (p.stats.stress > 80) eff *= 0.5;
            if (GameConfig.Calendar.holidays.includes(StateManager.data.game.turn)) eff *= 1.1;
            return eff;
        },

        canAfford: function(costT, costS, costM = 0) {
            const p = StateManager.data.player;
            if (p.stats.time < costT) return { ok: false, msg: "æ—¶é—´ä¸è¶³" };
            if (p.stats.stamina < costS) return { ok: false, msg: "ä½“åŠ›é€æ”¯" };
            if (p.stats.money < costM) return { ok: false, msg: "é‡‘é’±ä¸è¶³" };
            return { ok: true };
        },

        doStudy: function(subId) {
            const sub = GameConfig.Subjects[subId];
            const check = Engine.canAfford(sub.costT, sub.costS);
            if (!check.ok) return UI.log(check.msg, "red");
            
            const p = StateManager.data.player;
            p.stats.time -= sub.costT; 
            p.stats.stamina -= sub.costS;
            
            const eff = Engine.calculateEfficiency();
            const gain = eff * (1 + (p.stats[sub.boost] || 0) * 0.1);
            p.stats[sub.boost] += gain * 0.5; 
            p.stats.iq += 0.02; 
            p.stats.stress += 3;
            
            UI.log(`[${sub.name}] èƒ½åŠ›+${gain.toFixed(1)}`);
            UI.renderGame();
        },

        doRest: function(type) {
            const p = StateManager.data.player;
            if (type === 'nap') {
                if (p.stats.time < 10) return UI.log("æ²¡æ—¶é—´æ‰“ç›¹äº†ï¼", "red");
                p.stats.time -= 10; 
                p.stats.stamina = Math.min(200, p.stats.stamina + 10); 
                p.stats.stress = Math.max(0, p.stats.stress - 2);
                UI.log("æ‰“ç›¹: ä½“åŠ›+10, æ—¶é—´-10", "green");
            } else if (type === 'sleep') {
                if (p.stats.time < 80) return UI.log("æ—¶é—´ä¸å¤Ÿæ·±ç¡ï¼", "red");
                p.stats.time -= 80; 
                p.stats.stamina = 200; 
                p.stats.stress = Math.max(0, p.stats.stress - 25);
                UI.log("æ·±åº¦ç¡çœ : ç²¾åŠ›å……æ²›!", "#2ecc71");
            } else if (type === 'play') {
                if (p.stats.time < 50) return UI.log("æ²¡æ—¶é—´ç©äº†ï¼", "red");
                p.stats.time -= 50; 
                p.stats.stamina -= 10; 
                p.stats.stress = Math.max(0, p.stats.stress - 40);
                UI.log("å¨±ä¹: å‹åŠ›å¤§å¹…ä¸‹é™", "yellow");
            }
            UI.renderGame();
        },

        doCompTrain: function() {
            const check = Engine.canAfford(80, 40);
            if (!check.ok) return UI.log(check.msg, "red");
            
            const p = StateManager.data.player;
            p.stats.time -= 80; 
            p.stats.stamina -= 40;
            p.stats.logic += 1.2; 
            p.stats.iq += 0.1; 
            p.stats.stress += 10;
            
            UI.log("ç«èµ›é›†è®­: é€»è¾‘æš´æ¶¨ï¼Œèº«å¿ƒä¿±ç–²ã€‚", "#9b59b6");
            UI.renderGame();
        },

        doSocial: function(npcId) {
            const npc = GameConfig.NPCs.find(n => n.id === npcId);
            const check = Engine.canAfford(npc.cost.t, npc.cost.s, npc.cost.m);
            if (!check.ok) return UI.log(check.msg, "red");
            
            const p = StateManager.data.player;
            p.stats.time -= npc.cost.t; 
            p.stats.stamina -= npc.cost.s; 
            p.stats.money -= npc.cost.m;
            p.affinity[npcId] = (p.affinity[npcId] || 0) + 20;
            
            if (npcId === 'anon' && p.affinity['anon'] >= 100) AchievementManager.unlock("ANON_100");
            
            if (npcId === 'xiao' && p.affinity['xiao'] >= 80 && !p.hasSecretManual && (p.stats.iq + p.stats.logic < 15)) {
                p.hasSecretManual = true; 
                AchievementManager.unlock("FEN_JUE"); 
                p.stats.logic += 10;
                UI.log("ã€å¥‡é‡ã€‘è§ç«ç«èµ äºˆä½ ã€Šä¸‰å¹´æ¨¡æ‹Ÿäº”å¹´é«˜è€ƒã€‹ï¼", "#e67e22");
            }
            
            if (p.affinity[npcId] === 100) StateManager.data.history.npcBondCount++;
            
            UI.log(`[ç¤¾äº¤] ${npc.name}: ${npc.effect(p)} (å¥½æ„Ÿ${p.affinity[npcId]})`, "#e91e63");
            UI.renderGame();
        },

        passTurn: function() {
            const g = StateManager.data.game;
            const p = StateManager.data.player;
            const h = StateManager.data.history;
            const school = Engine.getSchoolConfig();

            // 1. å‹åŠ›å¢åŠ 
            p.stats.stress += school.stress;
            if (p.stats.stress > h.maxStress) h.maxStress = p.stats.stress;
            
            // 2. å´©æºƒæ£€æµ‹
            if (p.stats.stress >= 100) {
                h.crisisCount++;
                if (p.stats.stress >= 120 || h.crisisCount >= 3) {
                    const currentPower = p.stats.iq + p.stats.logic + p.stats.mem + p.stats.img;
                    return Engine.triggerEnding('BE1', Math.floor(currentPower / 2.0), "åŒ»é™¢/å®¶é‡Œè¹²(ä¼‘/é€€å­¦)");
                }
                UI.log("ã€å´©æºƒã€‘æœ¬å‘¨å¿ƒç†é˜²çº¿å´©å¡Œï¼", "red");
                p.stats.stress = 60; 
                p.stats.time = 0;
            }

            // 3. äº‹ä»¶æ£€æŸ¥
            Engine.checkCompetition(g.turn);
            
            if (GameConfig.Calendar.exams.includes(g.turn)) {
                Engine.triggerExam(g.turn, school);
            }

            // 4. ä¸‹ä¸€å‘¨
            g.turn++;

            if (g.turn === 17 || g.turn === 33) {
                UI.log(`========== æ–°å­¦å¹´å¼€å§‹ ==========`, "cyan");
                p.compStatus.currentStage = 0;
            }

            // 5. å‡æœŸä¸ç»“æŸåˆ¤å®š
            if (g.turn > GameConfig.MAX_TURNS) {
                Engine.calculateEnding();
            } else {
                const isHoliday = GameConfig.Calendar.holidays.includes(g.turn);
                if (isHoliday) {
                    p.stats.time = 600; 
                    p.stats.stamina = 200; 
                    p.stats.stress = Math.floor(p.stats.stress / 2);
                    UI.log(`>>> ${GameConfig.Calendar.getDesc(g.turn)} æ¥äº†ï¼`, "#e67e22");
                } else {
                    p.stats.time = GameConfig.TIME_PER_TURN; 
                    p.stats.stamina = Math.min(100, p.stats.stamina + 20);
                    UI.log(`>>> è¿›å…¥ç¬¬ ${g.turn} å‘¨ã€‚`, "#aaa");
                }
                StateManager.save();
                UI.renderGame();
            }
        },

        checkCompetition: function(turn) {
            const p = StateManager.data.player;
            if (!p.compStatus.joined) return;
            
            const event = GameConfig.CompetitionSchedule[turn];
            if (!event) return;
            
            // æ£€æŸ¥é˜¶æ®µè¿è´¯æ€§
            if (event.stage > 1 && p.compStatus.currentStage < (event.stage - 1)) return;

            const power = p.stats.logic * 1.5 + p.stats.iq * 2;
            const roll = Math.random() * 30;
            
            if ((power * 4 + roll) >= event.req) {
                p.compStatus.currentStage = event.stage;
                p.compStatus.bestRecord = event.name;
                
                if (event.stage === 4) {
                    p.compStatus.hasNational = true;
                    AchievementManager.unlock("KING");
                    if ((power * 4 + roll) >= event.req + 100) { 
                        p.compStatus.hasGold = true; 
                        AchievementManager.unlock("PEAK"); 
                    }
                }
                UI.log(`>>> ã€æ·æŠ¥ã€‘${event.name} æ™‹çº§ï¼`, "#2ecc71");
            } else {
                UI.log(`>>> ã€é—æ†¾ã€‘${event.name} è½æ¦œã€‚`, "red");
            }
        },

        triggerExam: function(turn, school) {
            const p = StateManager.data.player;
            const power = p.stats.iq + p.stats.logic + p.stats.mem + p.stats.img;
            const difficulty = 1 + (turn / 35);
            
            let score = 300 + (power * 7 / difficulty) + Math.random() * 30;
            score = Math.floor(Math.min(750, score));

            if (turn === 48) { 
                p.stats.finalScore = score; 
                return; 
            }
            
            UI.log(`${turn > 40 ? "ã€æ¨¡æ‹Ÿè€ƒã€‘" : "ã€ç»Ÿè€ƒã€‘"} æ€»åˆ†: ${score}`, "orange");

            if (score < school.minScore) {
                StateManager.data.history.failedExams++;
                p.stats.satisfaction -= 15; 
                p.stats.stress += 10;
                UI.log("æˆç»©æœªè¾¾æ ‡ï¼", "red");
            } else {
                p.stats.satisfaction += 5; 
                p.stats.money += 200;
                UI.log("æˆç»©è¾¾æ ‡ï¼", "green");
            }
        },

        joinCompetition: function() {
            StateManager.data.player.compStatus.joined = true;
            UI.log("å·²æŠ¥åå¥¥æ—åŒ¹å…‹ç«èµ›ã€‚", "cyan");
            StateManager.save();
            UI.renderGame();
        },

        calculateEnding: function() {
            const p = StateManager.data.player;
            const h = StateManager.data.history;
            const score = p.stats.finalScore || 300;
            
            let tier = "tier1";
            if (score >= 700) tier = "tier9"; 
            else if (score >= 670) tier = "tier8"; 
            else if (score >= 640) tier = "tier7";
            else if (score >= 610) tier = "tier6"; 
            else if (score >= 580) tier = "tier5"; 
            else if (score >= 530) tier = "tier4";
            else if (score >= 480) tier = "tier3"; 
            else if (score >= 400) tier = "tier2";

            const uniList = GameConfig.UniversityList[tier].list;
            const finalUni = uniList[Math.floor(Math.random() * uniList.length)];
            
            if (tier === 'tier9' || tier === 'tier8') AchievementManager.unlock("TOP_SCH");

            let endID = "DEF";
            if (score < 400) endID = "BE2"; 
            else if (h.npcBondCount >= 2 && score >= 670 && p.compStatus.hasNational) endID = "PE";
            else if (score >= 670 && p.stats.iq < 10 && p.stats.logic < 10 && p.stats.mem < 10) endID = "IE";
            else if (p.compStatus.hasGold) endID = "SE2"; 
            else if (score >= 670 && h.maxStress < 90 && p.stats.satisfaction > 70) endID = "EX1";
            else if (h.maxStress >= 95 && score >= 610) endID = "GE1"; 
            else if (h.failedExams >= 2 && score >= 610) endID = "GE2";
            else if (p.compStatus.hasNational) endID = "SE1"; 
            else if (h.crisisCount === 0 && score >= 640) endID = "JSE";
            else if (score >= 480) endID = "NE";
            
            Engine.triggerEnding(endID, score, finalUni);
        },

        triggerEnding: function(id, score, uni) {
            // [ä¿®å¤ç‚¹ 1] å¿…é¡»åœ¨è¿™é‡Œå®šä¹‰ pï¼Œå¦åˆ™ä¸‹æ–¹å‘é€æ•°æ®ä¼šæŠ¥é”™
            const p = StateManager.data.player;
            StateManager.data.game.isGameOver = true;
            document.getElementById('screen-game').classList.add('hidden');
            
            const endScreen = document.createElement('div');
            endScreen.id = 'screen-ending';
            endScreen.style = "width:100%;max-width:700px;border:2px solid white;padding:40px;text-align:center;animation:fadeIn 2s;";
            const endData = GameConfig.Endings[id];
            
            endScreen.innerHTML = `
                <h1 style="font-size:3rem; margin:0 0 20px 0; color:${endData.color}">${endData.title}</h1>
                <div style="font-size:1.2rem; color:#aaa; margin-bottom:40px;">${endData.desc}</div>
                <div style="border-top:1px dashed #666; border-bottom:1px dashed #666; padding:20px; margin-bottom:30px;">
                    <p>${id === 'BE1' ? 'ç»¼åˆèƒ½åŠ›è¯„ä»·' : 'é«˜è€ƒæ€»åˆ†'}: <span style="font-size:2rem; font-weight:bold; color:white">${id === 'BE1' ? '???' : (score || "???")}</span></p>
${uni ? `<p>${id === 'BE1' ? 'å½“å‰çŠ¶æ€' : 'å½•å–é™¢æ ¡'}: <span style="font-size:1.5rem; color:#3498db">${uni}</span></p>` : ''}
                </div>
                <p style="color:#666; font-size:0.8rem;">ID: ${StateManager.data.player.name} | MaxStress: ${StateManager.data.history.maxStress}</p>
                <button class="btn" onclick="location.reload()" style="margin-top:20px; border-color:${endData.color}; color:${endData.color}">>> å†æ¬¡é‡ç”Ÿ (Rebirth)</button>
            `;
            document.body.appendChild(endScreen);
            // [åç«¯åŒæ­¥] ä¸Šä¼ æˆç»©å¹¶ç”ŸæˆæŒ‰é’®
            (async () => {
                try {
                    const res = await fetch('/api/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: p.name, score: score, uni: uni, ending: endData.title })
                    });
                    const result = await res.json();
                    const shareUrl = `${window.location.origin}/?shareId=${result.shareId}`;
        
                    const shareBtn = document.createElement('button');
                    shareBtn.className = 'btn';
                    shareBtn.style.marginTop = "20px";
                    shareBtn.innerText = "ğŸ”— å¤åˆ¶æˆ‘çš„é‡ç”Ÿé“¾æ¥";
                    shareBtn.onclick = () => {
                        navigator.clipboard.writeText(shareUrl);
                        alert("é“¾æ¥å·²å¤åˆ¶ï¼ç»™æœ‹å‹ä»¬ä¸€ç‚¹å°å°éœ‡æ’¼ï¼");
                    };
                    endScreen.appendChild(shareBtn);
                } catch (e) { console.error("Sync Failed"); }
            })();
            document.getElementById('game-container').classList.add('hidden');
        }
    };

    /* -----------------------------------------------------------------
       MODULE 4: UI CONTROLLER (è§†å›¾ä¸äº¤äº’)
       ----------------------------------------------------------------- */
    const UI = {
        init: function() { 
            AchievementManager.init(); 
            SetupUI.init(); 
        },

        renderGame: function() {
            const p = StateManager.data.player;
            const g = StateManager.data.game;
            const sc = Engine.getSchoolConfig();

            // é˜²å¾¡æ€§æ£€æŸ¥
            if (!p.compStatus) p.compStatus = { joined: false, currentStage: 0 };

            // Header Update
            const mainPanel = document.getElementById('col-main');
            const headerH3 = mainPanel.querySelector('h3');
            if (headerH3) headerH3.innerText = `ID: ${p.name}`;
            
            const turnEl = document.getElementById('ui-turn');
            turnEl.innerText = `WEEK ${g.turn}`;
            turnEl.style.background = GameConfig.Calendar.holidays.includes(g.turn) ? "#e67e22" : "white";
            
            document.getElementById('ui-countdown').innerText = GameConfig.MAX_TURNS - g.turn;
            document.getElementById('ui-school').innerText = sc.name + " " + GameConfig.Calendar.getDesc(g.turn);

            // Stats Update
            const statsBox = document.getElementById('ui-stats-container');
            statsBox.innerHTML = '';
            
            let maxTime = GameConfig.Calendar.holidays.includes(g.turn) ? 600 : 300;
            let maxSta = GameConfig.Calendar.holidays.includes(g.turn) ? 200 : p.stats.maxStamina;
            
            const bars = [
                { l: "æ—¶é—´", v: p.stats.time, m: maxTime, c: "#9b59b6" },
                { l: "ä½“åŠ›", v: p.stats.stamina, m: maxSta, c: "#2ecc71" },
                { l: "å‹åŠ›", v: p.stats.stress, m: 100, c: p.stats.stress > 80 ? "#e74c3c" : "#3498db" },
                { l: "æ»¡æ„", v: p.stats.satisfaction, m: 100, c: "#f1c40f" }
            ];
            
            bars.forEach(b => {
                const pct = Math.min(100, (b.v / b.m) * 100);
                statsBox.innerHTML += `
                    <div class="stat-bar">
                        <div style="display:flex;justify-content:space-between;font-size:0.8rem">
                            <span>${b.l}</span><span>${Math.floor(b.v)}/${b.m}</span>
                        </div>
                        <div class="progress-track">
                            <div class="progress-fill" style="width:${pct}%;background:${b.c}"></div>
                        </div>
                    </div>`;
            });

            // Skills Section
            statsBox.innerHTML += `<div style="margin-top:15px; border-top:1px dashed #555; padding-top:5px; font-size:0.9rem; font-weight:bold; color:#aaa;">ğŸ“š å­¦ç§‘èƒ½åŠ›</div>`;
            const allSubs = ['chn', 'math', 'eng'].concat(p.subjects);
            let subGrid = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:5px;">`;
            
            allSubs.forEach(subId => {
                const sub = GameConfig.Subjects[subId];
                const val = p.stats[sub.boost].toFixed(1);
                let color = "#bbb";
                if (val > 25) color = "#2ecc71"; 
                if (val > 50) color = "#f1c40f"; 
                if (val > 75) color = "#e67e22"; 
                if (val > 100) color = "#e74c3c";
                subGrid += `<div style="background:#222; padding:4px; border-radius:3px; font-size:0.8rem; display:flex; justify-content:space-between;"><span>${sub.name}</span><span style="color:${color}; font-weight:bold;">${val}</span></div>`;
            });
            subGrid += `</div>`;
            statsBox.innerHTML += subGrid;

            // Traits Section
            statsBox.innerHTML += `<div style="margin-top:15px; border-top:1px dashed #555; padding-top:5px; font-size:0.9rem; font-weight:bold; color:#aaa;">ğŸ§¬ å›ºæœ‰å¤©èµ‹</div>`;
            statsBox.innerHTML += `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;font-size:0.8rem;margin-top:5px;">
                    <div>ğŸ§  æ™ºåŠ›: ${p.stats.iq.toFixed(1)}</div>
                    <div>âœ¨ é­…åŠ›: ${p.stats.charm}</div>
                    <div>ğŸ’° é‡‘é’±: $${p.stats.money}</div>
                    <div>ğŸ  å®¶å¢ƒ: ${p.stats.fam}</div>
                </div>`;
            
            if (p.compStatus.joined) {
                statsBox.innerHTML += `<div style="margin-top:10px;font-size:0.8rem;color:#9b59b6;text-align:center;border:1px solid #9b59b6;padding:3px;">ğŸ† ç«èµ›æœ€ä½³: ${p.compStatus.bestRecord}</div>`;
            }

            // Actions Section
            const actBox = document.getElementById('ui-actions');
            actBox.innerHTML = '';
            
            const nextBtn = document.createElement('button');
            nextBtn.className = 'btn'; 
            nextBtn.style = "width:100%; margin-bottom:10px; border-color:#9b59b6; color:#9b59b6";
            nextBtn.innerText = ">> ç»“æŸæœ¬å‘¨ >>"; 
            nextBtn.onclick = () => Engine.passTurn();
            actBox.appendChild(nextBtn);

            // [Competition Logic Fix]
            if (!p.compStatus.joined && g.turn <= 12) {
                actBox.appendChild(UI.btn("ğŸ† æŠ¥åç«èµ›", () => Engine.joinCompetition()));
            } else if (p.compStatus.joined) {
                actBox.appendChild(UI.smartBtn("ğŸ”¥ ç«èµ›é›†è®­", 80, 40, () => Engine.doCompTrain()));
            }

            actBox.appendChild(UI.sep("STUDY"));
            allSubs.forEach(k => { 
                const s = GameConfig.Subjects[k]; 
                actBox.appendChild(UI.smartBtn(`${s.name} (-${s.costT}t/-${s.costS}s)`, s.costT, s.costS, () => Engine.doStudy(k))); 
            });

            const activeNPCs = GameConfig.NPCs.filter(npc => npc.condition(p));
            if (activeNPCs.length > 0) {
                actBox.appendChild(UI.sep("SOCIAL"));
                activeNPCs.forEach(npc => {
                    actBox.appendChild(UI.smartBtn(`ğŸ’¬ ${npc.name} (-${npc.cost.t}t)`, npc.cost.t, npc.cost.s, () => Engine.doSocial(npc.id), npc.cost.m));
                });
            }

            actBox.appendChild(UI.sep("REST"));
            actBox.appendChild(UI.smartBtn("âš¡ æ‰“ç›¹ (-10t/+10s)", 10, 0, () => Engine.doRest('nap')));
            actBox.appendChild(UI.smartBtn("ğŸ›Œ æ·±ç¡ (-80t/Full)", 80, 0, () => Engine.doRest('sleep')));
            actBox.appendChild(UI.smartBtn("ğŸ® å¨±ä¹ (-50t/-10s)", 50, 10, () => Engine.doRest('play')));
        },

        toast: function(msg) {
            const t = document.createElement('div');
            t.style = "position:fixed; bottom:20px; right:20px; background:#f1c40f; color:black; padding:10px 20px; border-radius:4px; font-weight:bold; animation:fadeInOut 3s forwards; z-index:9999";
            t.innerText = msg; 
            document.body.appendChild(t); 
            setTimeout(() => t.remove(), 3000);
        },

        /*showAchievements: function() {
            const setupBox = document.getElementById('screen-setup');
            let achHTML = `<h2 style="border-bottom:2px solid white; padding-bottom:10px">ğŸ† è£èª‰å®¤</h2><div style="display:flex; flex-direction:column; gap:10px; height:80%; overflow-y:auto">`;
            for (let id in GameConfig.Achievements) {
                const ach = GameConfig.Achievements[id]; 
                const unlocked = AchievementManager.isUnlocked(id);
                const icon = unlocked ? "ğŸŸ¡" : "âšª"; 
                const color = unlocked ? "white" : "#666"; 
                const status = unlocked ? "[å·²è¾¾æˆ]" : "[æœªè¾¾æˆ]";
                achHTML += `
                    <div style="border:1px solid ${color}; padding:10px; border-radius:4px; color:${color}">
                        <div style="font-weight:bold; font-size:1.1rem; margin-bottom:5px;">${icon} ${ach.title} <span style="font-size:0.8rem; opacity:0.7">${status}</span></div>
                        <div style="font-size:0.9rem; margin-bottom:5px;">è¾¾æˆæ¡ä»¶: ${unlocked ? ach.cond : "???"}</div>
                        <div style="font-size:0.8rem; font-style:italic; color:#aaa;">"${ach.desc}"</div>
                    </div>`;
            }
            achHTML += `</div><button class="btn" onclick="location.reload()" style="margin-top:20px">è¿”å›</button>`;
            setupBox.innerHTML = achHTML;
        },*/
        //Update Here- Final Update
        showAchievements: function() {
            // [V5.5.4 FIX] ä½¿ç”¨è¦†ç›–å±‚ä»£æ›¿é¡µé¢é‡ç»˜ï¼Œé˜²æ­¢å¸ƒå±€è·³åŠ¨å’Œæ•°æ®ä¸¢å¤±
            const overlay = document.createElement('div');
            overlay.id = 'ach-overlay';
            // å…¨å±é»‘åº•é®ç½©
            overlay.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(5,5,5,0.98); z-index:5000; display:flex; flex-direction:column; align-items:center; justify-content:center; animation:fadeIn 0.3s;";
            
            let achHTML = `
                <div style="width:90%; max-width:600px; height:70%; overflow-y:auto; border:2px solid white; padding:20px; background:black; box-shadow:0 0 30px rgba(255,255,255,0.1);">
                    <h2 style="border-bottom:2px solid white; padding-bottom:15px; margin-top:0; text-align:center;">ğŸ† è£èª‰å®¤ (Hall of Fame)</h2>
                    <div style="display:flex; flex-direction:column; gap:10px;">
            `;
            
            for (let id in GameConfig.Achievements) {
                const ach = GameConfig.Achievements[id];
                const unlocked = AchievementManager.isUnlocked(id);
                const icon = unlocked ? "ğŸŸ¡" : "âšª";
                const color = unlocked ? "white" : "#444"; // æœªè§£é”ç¨å¾®æš—ä¸€ç‚¹
                const border = unlocked ? "white" : "#333";
                const status = unlocked ? "<span style='color:#2ecc71'>[å·²è¾¾æˆ]</span>" : "<span style='color:#666'>[LOCKED]</span>";
                
                achHTML += `
                    <div style="border:1px solid ${border}; padding:12px; border-radius:4px; color:${color}; transition:transform 0.2s">
                        <div style="font-weight:bold; font-size:1.1rem; margin-bottom:5px; display:flex; justify-content:space-between;">
                            <span>${icon} ${ach.title}</span>
                            <span style="font-size:0.8rem;">${status}</span>
                        </div>
                        <div style="font-size:0.9rem; margin-bottom:5px; color:${unlocked?'#ddd':'#666'}">
                            æ¡ä»¶: ${unlocked ? ach.cond : "???????????"}
                        </div>
                        <div style="font-size:0.8rem; font-style:italic; color:${unlocked?'#aaa':'#444'};">
                            "${ach.desc}"
                        </div>
                    </div>
                `;
            }
            
            achHTML += `
                    </div>
                </div>
                <button class="btn" style="margin-top:30px; width:200px; border-color:white;" onclick="document.getElementById('ach-overlay').remove()">
                    ğŸ”™ è¿”å› (BACK)
                </button>
            `;
            
            overlay.innerHTML = achHTML;
            document.body.appendChild(overlay);
        },

        showCloudRank: async function() {
            const overlay = document.createElement('div');
        overlay.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:9000; display:flex; flex-direction:column; align-items:center; justify-content:center;";
        overlay.innerHTML = `<h2 style="color:#ffd700">ğŸ† å…¨çƒé‡ç”Ÿæˆç»©æ¦œ</h2><div id="rank-content" style="color:white; width:80%; max-width:400px">åŠ è½½ä¸­...</div><button class="btn" onclick="this.parentElement.remove()">å…³é—­</button>`;
        document.body.appendChild(overlay);

            try {
                const res = await fetch('/api/rank');
                const data = await res.json();
                let html = '<table style="width:100%; text-align:left; margin:20px 0;"><tr><th>åæ¬¡</th><th>ä»£å·</th><th>åˆ†æ•°</th></tr>';
                data.forEach((item, i) => {
                html += `<tr style="border-bottom:1px solid #333"><td>${i+1}</td><td>${item.name}</td><td>${item.score}</td></tr>`;
                });
                html += '</table>';
                document.getElementById('rank-content').innerHTML = html;
            } catch (e) { document.getElementById('rank-content').innerText = "è·å–å¤±è´¥ï¼ŒæœåŠ¡å™¨æœªå“åº”"; }
        },

        smartBtn: function(txt, costT, costS, cb, costM = 0) {
            const p = StateManager.data.player; 
            const btn = document.createElement('button'); 
            btn.className = 'btn'; btn.style.width = '100%'; btn.style.marginBottom = '4px';
            let disabled = false; let note = "";
            if (p.stats.time < costT) { disabled = true; note = "(æ— æ—¶é—´)"; } 
            else if (p.stats.stamina < costS) { disabled = true; note = "(å¤ªç´¯)"; } 
            else if (p.stats.money < costM) { disabled = true; note = "(æ²¡é’±)"; }
            
            if (disabled) { 
                btn.disabled = true; 
                btn.innerText = txt + " " + note; 
                btn.style.borderColor = "#444"; 
                btn.style.color = "#666"; 
            } else { 
                btn.innerText = txt; 
                btn.onclick = cb; 
            }
            return btn;
        },

        btn: function(txt, cb) { 
            let b = document.createElement('button'); 
            b.className = 'btn'; 
            b.style.width = '100%'; 
            b.style.marginBottom = '5px'; 
            b.innerText = txt; 
            b.onclick = cb; 
            return b; 
        },

        sep: function(t) { 
            const d = document.createElement('div');
            d.innerHTML = `--- ${t} ---`;
            d.style = "text-align:center;color:#666;font-size:0.7rem;margin:8px 0";
            return d;
        },

        log: function(m, c = "white") {
            let d = document.createElement('div'); 
            d.className = 'log-entry'; 
            d.style.color = c;
            d.innerHTML = `<span class="log-turn">[W${StateManager.data.game.turn}]</span> ${m}`;
            
            const logBox = document.getElementById('game-log');
            logBox.prepend(d); // æ–°æ¶ˆæ¯æ”¾æœ€ä¸Šé¢
            
            // [ACMer ä¼˜åŒ–ï¼šæ—¥å¿—å‰ªæ]
            // å¦‚æœæ—¥å¿—æ¡æ•°è¶…è¿‡ 40 æ¡ï¼Œç§»é™¤æœ€æ—§çš„ä¸€æ¡ï¼ˆæœ€åé¢çš„å­å…ƒç´ ï¼‰
            if (logBox.children.length > 40) {
                logBox.removeChild(logBox.lastChild);
            }
            
            // æ¯æ¬¡å‘æ–°æ¶ˆæ¯ï¼Œè‡ªåŠ¨å›æ»šåˆ°æœ€é¡¶éƒ¨ï¼Œç¡®ä¿æ–°æ¶ˆæ¯å¯è§
            logBox.scrollTop = 0;
        }
    };

/* -----------------------------------------------------------------
       MODULE 5: SETUP UI (V5.5.3 FIXED - ä¿®å¤å˜é‡åé”™è¯¯)
       ----------------------------------------------------------------- */
    const SetupUI = {
        selectedSub: [],
        curDiff: 'normal',
        curSchoolTier: 'ordinary',
        curSchoolStyle: 'balanced',
        alloc: {},

        init: function() {
            this.resetStats();
            
            // [ä¿®æ­£ä½ç½®] å…ˆè·å– DOM å…ƒç´ 
            const setupScreen = document.getElementById('screen-setup');
            
            // æ’å…¥æ’è¡Œæ¦œæŒ‰é’®
            const rankBtn = document.createElement('button');
            rankBtn.className = 'btn';
            rankBtn.style.width = '100%';
            rankBtn.style.marginBottom = '20px';
            rankBtn.innerText = "ğŸŒ å…¨çƒæ’è¡Œæ¦œ";
            rankBtn.onclick = () => UI.showCloudRank();
            setupScreen.prepend(rankBtn);

            // æ’å…¥è£èª‰å®¤æŒ‰é’®
            const achBtn = document.createElement('button');
            achBtn.className = 'btn';
            achBtn.style.width = '100%'; // åŠ ä¸Šå®½åº¦ä¸€è‡´
            achBtn.style.marginBottom = '20px';
            achBtn.innerText = "ğŸ† æŸ¥çœ‹è£èª‰å®¤";
            achBtn.onclick = () => UI.showAchievements();
            setupScreen.prepend(achBtn);
            
            if (StateManager.hasSave()) {
                const loadBtn = document.createElement('button');
                loadBtn.className = 'btn';
                loadBtn.style.width = '100%';
                loadBtn.style.borderColor = '#2ecc71';
                loadBtn.innerText = ">> è¯»å–æ®‹ç•™è®°å¿†";
                loadBtn.onclick = () => SetupUI.loadGame();
                document.getElementById('load-status').innerHTML = '';
                document.getElementById('load-status').appendChild(loadBtn);
            }
            this.render();
        },

        loadGame: function() {
            if (StateManager.load()) {
                document.getElementById('screen-setup').classList.add('hidden');
                document.getElementById('screen-game').classList.remove('hidden');
                UI.renderGame();
                UI.log("å­˜æ¡£è¯»å–æˆåŠŸã€‚", "#2ecc71");
            }
        },

        resetStats: function() {
            for (let k in GameConfig.Stats) this.alloc[k] = GameConfig.Stats[k].base;
            this.render();
        },

        applyPreset: function(type) {
            this.resetStats();
            let points = GameConfig.Difficulty[this.curDiff].points;
            const keys = Object.keys(this.alloc);

            while (points > 0) {
                if (type === 'random') {
                    let k = keys[Math.floor(Math.random() * keys.length)];
                    this.alloc[k]++;
                } else if (type === 'sci') {
                    if (points > 0) { this.alloc['iq']++; points--; }
                    if (points > 0) { this.alloc['logic']++; points--; }
                    if (points > 0) { this.alloc['mem']++; points--; }
                    continue;
                } else if (type === 'arts') {
                    if (points > 0) { this.alloc['mem']++; points--; }
                    if (points > 0) { this.alloc['img']++; points--; }
                    if (points > 0) { this.alloc['charm'] ? this.alloc['charm']++ : this.alloc['iq']++; points--; }
                    continue;
                }
                points--;
            }
            this.render();
        },

        render: function() {
            // 1. éš¾åº¦
            this.renderDOM('diff-select', GameConfig.Difficulty, (key) => {
                this.curDiff = key;
                this.resetStats();
            });
            document.getElementById('diff-desc').innerText = GameConfig.Difficulty[this.curDiff].desc;

            // 2. é«˜ä¸­é€‰æ‹© (å®¹å™¨æ£€æŸ¥)
            let schoolArea = document.getElementById('school-select-area');
            if (!schoolArea) {
                schoolArea = document.createElement('div');
                schoolArea.id = 'school-select-area';
                schoolArea.className = 'form-group';
                schoolArea.innerHTML = `<label>> é€‰æ‹©é«˜ä¸­:</label><div id="school-grid" class="grid-3" style="font-size:0.8rem"></div><p id="school-desc" style="font-size:0.8rem; color:#888; margin-top:5px"></p>`;
                document.getElementById('diff-select').parentNode.after(schoolArea);
            }
            
            const tiers = { ordinary: "æ™®é€š", key: "é‡ç‚¹", super: "è¶…çº§" };
            const styles = { relaxed: "å®½æ¾", balanced: "å‡è¡¡", strict: "ä¸¥æ ¼" };
            const schoolGrid = document.getElementById('school-grid');
            
            schoolGrid.innerHTML = `
                <div class="option-box" onclick="SetupUI.cycleTier()">Tier: ${tiers[this.curSchoolTier]}</div>
                <div class="option-box" onclick="SetupUI.cycleStyle()">Style: ${styles[this.curSchoolStyle]}</div>
                <div class="option-box selected" style="cursor:default; border-color:#aaa; color:#aaa">
                    ${GameConfig.Schools[this.curSchoolTier][this.curSchoolStyle].name}
                </div>
            `;
            
            const sc = GameConfig.Schools[this.curSchoolTier][this.curSchoolStyle];
            document.getElementById('school-desc').innerText = 
                `[${sc.buff}] æ•ˆç‡:${sc.eff} | å‹åŠ›:${sc.stress}/å‘¨ | åŠæ ¼çº¿:${sc.minScore}`;

            // 3. é€‰ç§‘
            this.renderDOM('sub-select', GameConfig.Subjects, (key) => {
                if (this.selectedSub.includes(key)) {
                    this.selectedSub = this.selectedSub.filter(x => x !== key);
                } else if (this.selectedSub.length < 3) {
                    this.selectedSub.push(key);
                }
            }, ['phy','chem','bio','his','pol','geo']);
            
            document.getElementById('sub-count').innerText = this.selectedSub.length;

            // 4. å±æ€§ç‚¹
            const statBox = document.getElementById('stat-select');
            statBox.innerHTML = '';
            
            const tools = document.createElement('div');
            tools.style = 'display:flex; gap:5px; margin-bottom:10px';
            tools.innerHTML = `
                <button class="btn" style="flex:1;padding:5px;font-size:0.8rem" onclick="SetupUI.applyPreset('random')">ğŸ²éšæœº</button>
                <button class="btn" style="flex:1;padding:5px;font-size:0.8rem" onclick="SetupUI.applyPreset('sci')">ğŸ§ªç†ç§‘</button>
                <button class="btn" style="flex:1;padding:5px;font-size:0.8rem" onclick="SetupUI.applyPreset('arts')">ğŸ¨æ–‡ç§‘</button>
                <button class="btn" style="flex:1;padding:5px;font-size:0.8rem" onclick="SetupUI.resetStats()">â™»ï¸é‡ç½®</button>
            `;
            statBox.appendChild(tools);

            let baseTotal = 0;
            for (let k in GameConfig.Stats) baseTotal += GameConfig.Stats[k].base;
            
            let used = 0;
            for (let k in this.alloc) used += this.alloc[k];
            
            let left = (baseTotal + GameConfig.Difficulty[this.curDiff].points) - used;
            
            const ptDisplay = document.getElementById('remain-pts');
            ptDisplay.innerText = left;
            ptDisplay.style.color = left < 0 ? 'red' : 'white';

            for (let k in GameConfig.Stats) {
                statBox.innerHTML += `
                    <div class="stat-allocator">
                        <span style="width:60px">${GameConfig.Stats[k].name}</span>
                        <button class="btn" onclick="SetupUI.mod('${k}', -1)">-</button>
                        <span style="width:30px; text-align:center">${this.alloc[k]}</span>
                        <button class="btn" onclick="SetupUI.mod('${k}', 1)">+</button>
                    </div>`;
            }

            // 5. å¯åŠ¨æŒ‰é’®
            const btn = document.getElementById('btn-start');
            if (this.selectedSub.length === 3 && left === 0) {
                btn.disabled = false;
                btn.innerText = ">> å¯åŠ¨é‡ç”Ÿç¨‹åº";
                btn.onclick = () => this.startGame();
            } else {
                btn.disabled = true;
                btn.innerText = "è®¾ç½®æœªå®Œæˆ";
            }
        },

        renderDOM: function(id, source, callback, filterKeys) {
            const box = document.getElementById(id);
            box.innerHTML = '';
            let keys = filterKeys || Object.keys(source);
            keys.forEach(key => {
                let div = document.createElement('div');
                let isSelected = this.selectedSub.includes(key) || this.curDiff === key;
                div.className = 'option-box ' + (isSelected ? 'selected' : '');
                div.innerText = source[key].name;
                div.onclick = () => {
                    callback(key);
                    this.render();
                };
                box.appendChild(div);
            });
        },

        mod: function(key, delta) {
            if (delta < 0 && this.alloc[key] > 1) this.alloc[key]--;
            if (delta > 0) this.alloc[key]++;
            this.render();
        },

        // [FIXED HERE] ä¿®å¤å˜é‡åå¼•ç”¨é”™è¯¯ keys -> k
        cycleTier: function() {
            const k = ['ordinary', 'key', 'super'];
            let idx = k.indexOf(this.curSchoolTier);
            this.curSchoolTier = k[(idx + 1) % 3];
            this.render();
        },

        // [FIXED HERE] ä¿®å¤å˜é‡åå¼•ç”¨é”™è¯¯ keys -> k
        cycleStyle: function() {
            const k = ['relaxed', 'balanced', 'strict'];
            let idx = k.indexOf(this.curSchoolStyle);
            this.curSchoolStyle = k[(idx + 1) % 3];
            this.render();
        },

        startGame: function() {
            const p = StateManager.data.player;
            p.name = document.getElementById('inp-name').value || "Player";
            p.diff = this.curDiff;
            p.subjects = this.selectedSub;
            p.schoolKey = { tier: this.curSchoolTier, style: this.curSchoolStyle };
            
            for (let k in this.alloc) p.stats[k] = this.alloc[k];
            p.stats.money = GameConfig.Difficulty[this.curDiff].money;
            p.stats.time = GameConfig.TIME_PER_TURN;

            p.compStatus = { joined: false, currentStage: 0, bestRecord: "æ— ", hasGold: false, hasNational: false };
            p.affinity = { xiao: 0, anon: 0, night: 0, misaka: 0 };
            p.hasSecretManual = false;
            
            StateManager.data.history = { maxStress: 0, failedExams: 0, crisisCount: 0, npcBondCount: 0 };
            
            document.getElementById('screen-setup').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            UI.renderGame();
            UI.log("ç³»ç»Ÿå¯åŠ¨æˆåŠŸã€‚V5.5.3 Final Fixed.");
        }
    }; 

    /* -----------------------------------------------------------------
       MODULE 6: VISUAL FX (ç‰¹æ•ˆå¼•æ“)
       ----------------------------------------------------------------- */
    const FX = {
        init: function() { 
            this.initClickFX(); 
            this.initParticles(); 
            this.initSlogans(); 
        },

        initClickFX: function() {
            const words = ["å¯Œå¼º", "æ°‘ä¸»", "æ–‡æ˜", "å’Œè°", "è‡ªç”±", "å¹³ç­‰", "å…¬æ­£", "æ³•æ²»", "çˆ±å›½", "æ•¬ä¸š", "è¯šä¿¡", "å‹å–„", "â­", "â¤", "ğŸš©", "AC!", "RP++"];
            let index = 0;
            document.addEventListener('mousedown', function(e) {
                const span = document.createElement('span');
                const text = Math.random() > 0.3 ? words[index % 12] : words[Math.floor(Math.random() * words.length)];
                if (Math.random() > 0.3 && index < 12) index++;
                span.innerText = text;
                span.style.cssText = `position:fixed;left:${e.clientX}px;top:${e.clientY}px;color:${FX.getRandomColor()};font-weight:bold;font-size:1.2rem;pointer-events:none;user-select:none;z-index:9999;animation:floatUp 1s ease-out forwards;`;
                document.body.appendChild(span); 
                setTimeout(() => span.remove(), 1000);
            });
            const style = document.createElement('style');
            style.innerHTML = `@keyframes floatUp { 0% { transform: translate(-50%, 0) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -50px) scale(1.2); opacity: 0; } }`;
            document.head.appendChild(style);
        },

        getRandomColor: function() { 
            return ['#ff4757', '#2ed573', '#1e90ff', '#ffa502', '#ffffff', '#e84393'][Math.floor(Math.random() * 6)]; 
        },

        initParticles: function() {
            const canvas = document.getElementById('particle-canvas'); 
            const ctx = canvas.getContext('2d');
            let width, height; 
            let particles = []; 
            const mouse = { x: null, y: null, radius: 100 };
            
            window.addEventListener('mousemove', (e) => { mouse.x = e.x; mouse.y = e.y; });
            window.addEventListener('mouseout', () => { mouse.x = null; mouse.y = null; });
            
            function resize() { 
                width = canvas.width = window.innerWidth; 
                height = canvas.height = window.innerHeight; 
            }
            window.addEventListener('resize', resize); 
            resize();

            class Particle {
                constructor() {
                    this.x = Math.random() * width; 
                    this.y = Math.random() * height;
                    this.vx = (Math.random() - 0.5) * 0.5; 
                    this.vy = (Math.random() - 0.5) * 0.5;
                    this.size = Math.random() * 2 + 1; 
                    this.baseX = this.x; 
                    this.baseY = this.y; 
                    this.density = (Math.random() * 20) + 1;
                }
                draw() { 
                    ctx.beginPath(); 
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); 
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)'; 
                    ctx.fill(); 
                }
                update() {
                    if (mouse.x != null) {
                        let dx = mouse.x - this.x; 
                        let dy = mouse.y - this.y; 
                        let distance = Math.sqrt(dx * dx + dy * dy);
                        if (distance < mouse.radius) {
                            const forceDirectionX = dx / distance; 
                            const forceDirectionY = dy / distance;
                            const force = (mouse.radius - distance) / mouse.radius;
                            const directionX = forceDirectionX * force * this.density * 0.6; 
                            const directionY = forceDirectionY * force * this.density * 0.6;
                            this.x += directionX; 
                            this.y += directionY;
                        } else { 
                            if (this.x !== this.baseX) { let dx = this.x - this.baseX; this.x -= dx / 20; } 
                            if (this.y !== this.baseY) { let dy = this.y - this.baseY; this.y -= dy / 20; } 
                        }
                    }
                    this.baseX += this.vx; 
                    this.baseY += this.vy;
                    if (this.baseX < 0) this.baseX = width; 
                    if (this.baseX > width) this.baseX = 0; 
                    if (this.baseY < 0) this.baseY = height; 
                    if (this.baseY > height) this.baseY = 0;
                    this.draw();
                }
            }

            function initParts() { 
                particles = []; 
                let numberOfParticles = (width * height) / 9000; 
                for (let i = 0; i < numberOfParticles; i++) particles.push(new Particle()); 
            }
            initParts();

            function connect() {
                let opacityValue = 1;
                for (let a = 0; a < particles.length; a++) {
                    for (let b = a; b < particles.length; b++) {
                        let distance = ((particles[a].x - particles[b].x) * (particles[a].x - particles[b].x)) + 
                                       ((particles[a].y - particles[b].y) * (particles[a].y - particles[b].y));
                        if (distance < (canvas.width / 7) * (canvas.height / 7)) { 
                            opacityValue = 1 - (distance / 20000); 
                            if (opacityValue > 0) { 
                                ctx.strokeStyle = 'rgba(255, 255, 255,' + opacityValue * 0.2 + ')'; 
                                ctx.lineWidth = 1; 
                                ctx.beginPath(); 
                                ctx.moveTo(particles[a].x, particles[a].y); 
                                ctx.lineTo(particles[b].x, particles[b].y); 
                                ctx.stroke(); 
                            } 
                        }
                    }
                }
            }

            function animate() { 
                requestAnimationFrame(animate); 
                ctx.clearRect(0, 0, width, height); 
                for (let i = 0; i < particles.length; i++) particles[i].update(); 
                connect(); 
            }
            animate();
        },

        initSlogans: function() {
            const colStats = document.getElementById('col-stats'); 
            if (document.getElementById('slogan-box')) return;
            const box = document.createElement('div'); 
            box.id = 'slogan-box'; 
            box.innerHTML = `<span class="cursor"></span>`; 
            colStats.appendChild(box);
            
            const slogans = [
                "å…¥å®¤å³é™ï¼Œå…¥åº§å³å­¦", "åªè¦å­¦ä¸æ­»ï¼Œå°±å¾€æ­»é‡Œå­¦", "ä¹¾å¤æœªå®šï¼Œä½ æˆ‘çš†æ˜¯é»‘é©¬", 
                "å°†æ¥çš„ä½ ï¼Œä¸€å®šä¼šæ„Ÿè°¢ç°åœ¨æ‹¼å‘½çš„è‡ªå·±", "ç”Ÿå‰ä½•å¿…ä¹…ç¡ï¼Œæ­»åè‡ªä¼šé•¿çœ ", 
                "ç´¯äº†çœ‹çœ‹çˆ¶æ¯ï¼Œå€¦äº†æƒ³æƒ³å‰ç¨‹", "ä¸åƒè§’é©¬ä¸€æ ·è½åï¼Œè¦åƒé‡ç‹¼ä¸€æ ·æˆ˜æ–—", 
                "ç ´é‡œæ²‰èˆŸï¼Œæ‹¼ä»–ä¸ªæ—¥å‡ºæ—¥è½", "ç»†èŠ‚å†³å®šæˆè´¥ï¼Œæ€åº¦å†³å®šä¸€åˆ‡", 
                "å­¦å¦‚é€†æ°´è¡ŒèˆŸï¼Œä¸è¿›åˆ™é€€", "æ­¤åˆ»æ‰“ç›¹ï¼Œä½ å°†åšæ¢¦ï¼›æ­¤åˆ»å­¦ä¹ ï¼Œä½ å°†åœ†æ¢¦", 
                "åŠªåŠ›åˆ°æ— èƒ½ä¸ºåŠ›ï¼Œæ‹¼æåˆ°æ„ŸåŠ¨è‡ªå·±", "é†’é†’ï¼è¯¥å­¦ä¹ äº†ï¼", "æ²‰è¿·å­¦ä¹ ï¼Œæ—¥æ¸æ¶ˆç˜¦", 
                "åšå­¦ä¹‹ï¼Œå®¡é—®ä¹‹ï¼Œæ…æ€ä¹‹ï¼Œæ˜è¾¨ä¹‹ï¼Œç¬ƒè¡Œä¹‹", "ä¹¦å±±æœ‰è·¯å‹¤ä¸ºå¾„ï¼Œå­¦æµ·æ— æ¶¯è‹¦ä½œèˆŸ", 
                "å¾æ—¥ä¸‰çœå¾èº«ï¼šé«˜å¦ï¼Ÿå¯Œå¦ï¼Ÿå¸…å¦ï¼Ÿå¦ï¼Œæ»šå»å­¦ä¹ ï¼", 
                "ä¸å­¦ä¹ ï¼Œå¦‚ä½•å…»æ´»ä½ çš„ä¼—å¤šæ¸¸æˆï¼Ÿ", "ç¨³ä½ï¼Œæˆ‘ä»¬èƒ½èµ¢ï¼", "å­¦ä¹ ä½¿æˆ‘å¦ˆå¿«ä¹", 
                "é€šå¾€å¥½å¤§å­¦çš„è·¯ï¼Œæ˜¯ç”¨å·å­é“ºå‡ºæ¥çš„", "å®é™è‡´è¿œ", "åˆ†æ•°å°±æ˜¯ç¡¬é“ç†", 
                "åˆ«åœ¨æœ€å¥½çš„å¹´çºªï¼Œè¾œè´Ÿäº†æœ€å¥½çš„è‡ªå·±", "ä½ è®¨åŒçš„ç°åœ¨ï¼Œæ˜¯æœªæ¥çš„ä½ å›ä¸å»çš„æ›¾ç»"
            ];
            
            let sIdx = 0; 
            let charIdx = 0; 
            let currentText = ""; 
            let isDeleting = false; 
            const typeSpeed = 100; 
            const backSpeed = 50; 
            const pauseTime = 2000;
            
            function type() {
                const fullText = slogans[sIdx % slogans.length];
                if (isDeleting) { 
                    currentText = fullText.substring(0, charIdx - 1); 
                    charIdx--; 
                } else { 
                    currentText = fullText.substring(0, charIdx + 1); 
                    charIdx++; 
                }
                
                box.innerHTML = `${currentText}<span class="cursor"></span>`;
                
                let delta = isDeleting ? backSpeed : typeSpeed;
                if (!isDeleting && currentText === fullText) { 
                    delta = pauseTime; 
                    isDeleting = true; 
                } else if (isDeleting && currentText === "") { 
                    isDeleting = false; 
                    sIdx++; 
                    delta = 500; 
                }
                setTimeout(type, delta);
            }
            type();
        }
    };

    // --- BOOTSTRAP (å¯åŠ¨å…¥å£) ---
        // --- BOOTSTRAP (å¯åŠ¨å…¥å£) ---
    (async function() {
        FX.init();
        const isShare = await CloudSync.checkShareMode();
        if (!isShare) {
            UI.init();
        }
    })();
    </script>
</body>
</html>